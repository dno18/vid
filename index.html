<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة التحكم</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
      --dark-bg: #1a1a2e;
      --dark-element: #2c2c2c;
      --dark-text: #f5f7fa;
      --gradient: linear-gradient(135deg, var(--primary), var(--success));
      --header-bg: #4A5568; /* لون رمادي داكن رسمي */
      --header-dark-bg: #2D3748; /* لون أغمق للوضع الداكن */
      --header-hover-bg: #2D3748; /* لون الـ hover */
      --header-dark-hover-bg: #1A202C; /* لون الـ hover في الوضع الداكن */
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      scroll-behavior: smooth;
    }
    body {
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      background: url('https://www.transparenttextures.com/patterns/white-diamond.png'), linear-gradient(135deg, #f5f7ff, #e2e7ff);
      color: var(--dark);
      line-height: 1.6;
      transition: all 0.3s ease;
      position: relative;
      overflow-x: hidden;
      min-height: 100vh;
    }
    body.dark-mode {
      background: url('https://www.transparenttextures.com/patterns/dark-mosaic.png'), var(--dark-bg);
      color: var(--dark-text);
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px;
      position: relative;
      z-index: 1;
      animation: fadeIn 1s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    header {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 30px;
      margin-bottom: 40px;
      text-align: center;
      position: relative;
      overflow: hidden;
      animation: slideDown 0.8s ease-out;
    }
    .dark-mode header {
      background: var(--dark-element);
      box-shadow: 0 6px 25px rgba(255, 255, 255, 0.05);
    }
    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .logo-container {
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      position: relative;
    }
    .logo {
      max-width: 180px;
      transition: transform 0.4s ease, box-shadow 0.4s ease;
      animation: logoSpin 1.5s ease-in-out forwards;
      will-change: transform;
    }
    @keyframes logoSpin {
      0% { transform: scale(0) rotate(0deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(180deg); opacity: 0.5; }
      100% { transform: scale(1) rotate(360deg); opacity: 1; }
    }
    .logo:hover {
      transform: scale(1.05) rotate(5deg);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .dark-mode .logo:hover {
      box-shadow: 0 10px 30px rgba(255, 255, 255, 0.3);
    }
    .logo.scrolled {
      transform: scale(0.9);
      transition: transform 0.5s ease;
    }
    h1 {
      color: var(--primary);
      font-size: 2.5rem;
      margin-bottom: 15px;
      font-weight: 700;
      position: relative;
      animation: textFade 1.2s ease-out;
    }
    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      right: 0;
      width: 100px;
      height: 4px;
      background: var(--gradient);
      border-radius: 2px;
    }
    .dark-mode h1 {
      color: var(--success);
    }
    @keyframes textFade {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    header p {
      font-size: 1.1rem;
      color: var(--gray);
      animation: textFade 1.5s ease-out;
    }
    .dark-mode header p {
      color: #b0b0b0;
    }
    .buttons {
      display: flex;
      gap: 20px;
      margin-bottom: 40px;
      justify-content: center;
      flex-wrap: wrap;
      animation: buttonsFade 1.8s ease-out;
    }
    @keyframes buttonsFade {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    button {
      padding: 14px 30px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      background: white;
      color: var(--dark);
    }
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--gradient);
      opacity: 0.1;
      transition: left 0.4s ease;
      z-index: -1;
    }
    button:hover::before {
      left: 0;
    }
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      animation: pulse 0.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    button.primary {
      background: var(--gradient);
      color: white;
    }
    button.primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), #3aaed8);
    }
    .dark-mode button.primary {
      background: linear-gradient(135deg, var(--success), var(--primary));
    }
    button.secondary {
      background-color: white;
      color: var(--primary);
      border: 2px solid var(--primary);
    }
    button.secondary:hover {
      background-color: #f0f4ff;
    }
    .dark-mode button.secondary {
      background-color: var(--dark-element);
      color: var(--dark-text);
      border-color: var(--success);
    }
    .dark-mode button.secondary:hover {
      background-color: #3c3c3c;
    }
    button.export {
      background: linear-gradient(135deg, #28a745, #2ecc71);
      color: white;
    }
    button.export:hover {
      background: linear-gradient(135deg, #218838, #27ae60);
    }
    .dark-mode button.export {
      background: linear-gradient(135deg, #2ecc71, #28a745);
    }
    .section {
      display: none;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 40px;
      margin-top: 30px;
      animation: slideUp 0.8s ease-out;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }
    .dark-mode .section {
      background: var(--dark-element);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 2rem;
      position: relative;
      padding-bottom: 12px;
      animation: textFade 1s ease-out;
    }
    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: 0;
      width: 80px;
      height: 4px;
      background: var(--gradient);
      border-radius: 3px;
      animation: grow 1s ease-out;
    }
    @keyframes grow {
      from { width: 0; }
      to { width: 80px; }
    }
    .dark-mode h2 {
      color: var(--success);
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      color: var(--dark);
      animation: fadeIn 0.5s ease-out;
    }
    .dark-mode label {
      color: var(--dark-text);
    }
    input, select, textarea {
      width: 100%;
      padding: 14px 18px;
      margin-bottom: 25px;
      border-radius: var(--border-radius);
      border: 1px solid #e0e0e0;
      font-family: 'Tajawal', sans-serif;
      font-size: 15px;
      transition: all 0.3s ease;
      background: white;
      color: var(--dark);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    textarea {
      resize: vertical;
      min-height: 120px;
    }
    .dark-mode input, .dark-mode select, .dark-mode textarea {
      background: #333;
      color: var(--dark-text);
      border-color: #444;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
      transform: scale(1.01);
    }
    .dark-mode input:focus, .dark-mode select:focus, .dark-mode textarea:focus {
      border-color: var(--success);
      box-shadow: 0 0 0 4px rgba(76, 201, 240, 0.2);
    }
    .table-container {
      max-height: 450px;
      overflow-y: auto;
      position: relative;
      margin-top: 30px;
      width: 100%;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      background: white;
    }
    .dark-mode .table-container {
      background: var(--dark-element);
    }
    table {
      width: 100%;
      border-collapse: separate; /* لتفعيل خاصية border-spacing */
      border-spacing: 0;
      background: white;
      table-layout: fixed;
    }
    .dark-mode table {
      background: var(--dark-element);
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    th {
      background: var(--header-bg); /* اللون الرسمي الجديد */
      color: white;
      padding: 16px;
      text-align: center;
      font-weight: 600;
      font-size: 15px;
      border-right: 1px solid rgba(255, 255, 255, 0.2); /* حدود بين الأعمدة */
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(5px); /* تأثير زجاجي */
      transition: all 0.3s ease;
      position: relative;
      text-transform: uppercase; /* جعل النصوص أكثر رسمية */
      letter-spacing: 0.5px; /* تباعد بسيط بين الحروف */
    }
    th:last-child {
      border-right: none; /* إزالة الحد الأيمن من آخر عمود */
    }
    th:hover {
      background: var(--header-hover-bg); /* تغيير لون عند الـ hover */
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2); /* ظل داخلي */
    }
    .dark-mode th {
      background: var(--header-dark-bg);
    }
    .dark-mode th:hover {
      background: var(--header-dark-hover-bg);
      box-shadow: inset 0 2px 8px rgba(255, 255, 255, 0.1);
    }
    td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      text-align: center;
      color: var(--dark);
      word-wrap: break-word;
      transition: background-color 0.3s ease;
    }
    .dark-mode td {
      border-bottom: 1px solid #444;
      color: var(--dark-text);
    }
    tr {
      transition: transform 0.3s ease, background-color 0.3s ease;
    }
    tr:hover {
      background-color: #f8f9ff;
      transform: translateY(-2px);
    }
    .dark-mode tr:hover {
      background-color: #3c3c3c;
    }
    .actions {
      display: flex;
      flex-direction: column; /* جعل الأزرار فوق بعض */
      gap: 8px; /* مسافة بين الأزرار */
      justify-content: center;
      align-items: center;
      padding: 10px 0; /* زيادة المساحة العمودية */
    }
    .actions button {
      padding: 8px 16px; /* تصغير الأزرار قليلاً لتناسب العرض العمودي */
      font-size: 14px;
      margin: 0;
      width: 80px; /* جعل الأزرار بنفس العرض لتبدو متناسقة */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .actions button.edit {
      background: linear-gradient(135deg, #28a745, #2ecc71);
      color: white;
    }
    .dark-mode .actions button.edit {
      background: linear-gradient(135deg, #2ecc71, #28a745);
    }
    .actions button.delete {
      background: linear-gradient(135deg, var(--danger), #e74c3c);
      color: white;
    }
    .dark-mode .actions button.delete {
      background: linear-gradient(135deg, #e74c3c, var(--danger));
    }
    #loading {
      display: none;
      text-align: center;
      padding: 25px;
      font-size: 16px;
      color: var(--primary);
      animation: fadeIn 0.5s ease-out;
    }
    .dark-mode #loading {
      color: var(--success);
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 12px;
    }
    .dark-mode .spinner {
      border: 5px solid #444;
      border-top: 5px solid var(--success);
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .stats-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 25px;
      margin-bottom: 30px;
      animation: fadeIn 0.7s ease-out;
    }
    .dark-mode .stats-container {
      background: var(--dark-element);
    }
    .stats-container h3 {
      color: var(--primary);
      font-size: 1.3rem;
      margin-bottom: 12px;
    }
    .dark-mode .stats-container h3 {
      color: var(--success);
    }
    .stats-container p {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 20px;
    }
    .dark-mode .stats-container p {
      color: var(--dark-text);
    }
    .theme-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--light);
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      font-size: 22px;
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 2000;
      transition: all 0.3s ease;
    }
    .theme-toggle:hover {
      background: var(--gradient);
      color: white;
      transform: rotate(360deg) scale(1.1);
    }
    .dark-mode .theme-toggle {
      background: var(--dark-element);
      color: var(--dark-text);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }
    .dark-mode .theme-toggle:hover {
      background: linear-gradient(135deg, var(--success), var(--primary));
    }
    .duplicate-names-container {
      margin-top: 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .duplicate-names {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 15px;
      display: none;
      max-width: 350px;
      position: relative;
      animation: slideRight 0.6s ease-out;
    }
    .dark-mode .duplicate-names {
      background: var(--dark-element);
      color: var(--dark-text);
    }
    @keyframes slideRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .duplicate-names h3 {
      color: var(--primary);
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    .dark-mode .duplicate-names h3 {
      color: var(--success);
    }
    .duplicate-names ul {
      list-style: none;
      padding: 0;
      max-height: 180px;
      overflow-y: auto;
    }
    .duplicate-names li {
      padding: 8px 0;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 1px solid #f0f0f0;
    }
    .duplicate-names li:hover {
      background-color: #f0f4ff;
      padding-right: 10px;
    }
    .dark-mode .duplicate-names li {
      border-bottom: 1px solid #444;
    }
    .dark-mode .duplicate-names li:hover {
      background-color: #3c3c3c;
    }
    .duplicate-names li:last-child {
      border-bottom: none;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeInModal 0.4s ease-out;
    }
    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      padding: 25px;
      max-width: 900px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      animation: scaleIn 0.4s ease-out;
    }
    .dark-mode .modal-content {
      background: var(--dark-element);
      color: var(--dark-text);
    }
    @keyframes scaleIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .modal-content h3 {
      color: var(--primary);
      margin-bottom: 20px;
    }
    .dark-mode .modal-content h3 {
      color: var(--success);
    }
    .close-modal {
      position: absolute;
      top: 15px;
      left: 15px;
      font-size: 28px;
      cursor: pointer;
      color: var(--dark);
      transition: all 0.3s ease;
    }
    .close-modal:hover {
      color: var(--primary);
      transform: rotate(90deg);
    }
    .dark-mode .close-modal {
      color: var(--dark-text);
    }
    .dark-mode .close-modal:hover {
      color: var(--success);
    }
    .modal-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 15px;
    }
    .modal-table th {
      background: var(--header-bg);
      color: white;
      padding: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      border-right: 1px solid rgba(255, 255, 255, 0.2);
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }
    .modal-table th:last-child {
      border-right: none;
    }
    .modal-table th:hover {
      background: var(--header-hover-bg);
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .dark-mode .modal-table th {
      background: var(--header-dark-bg);
    }
    .dark-mode .modal-table th:hover {
      background: var(--header-dark-hover-bg);
      box-shadow: inset 0 2px 8px rgba(255, 255, 255, 0.1);
    }
    .modal-table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    .dark-mode .modal-table td {
      border-bottom: 1px solid #444;
    }
    @media (max-width: 768px) {
      .buttons { flex-direction: column; }
      .table-container { max-height: 350px; }
      .theme-toggle {
        top: 15px;
        left: 15px;
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
      .duplicate-names-container {
        flex-direction: column;
        align-items: stretch;
      }
      .duplicate-names {
        max-width: 100%;
      }
      .modal-content {
        width: 95%;
      }
      .logo {
        max-width: 140px;
      }
      h1 {
        font-size: 2rem;
      }
      .section {
        padding: 25px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="theme-toggle" id="theme-toggle" title="تبديل الوضع">
      <i class="fas fa-moon"></i>
    </button>

    <header>
      <div class="logo-container">
        <img src="https://i.postimg.cc/2jX0P9Mh/NHIJ1-Lp8i9-G4x-Nqy7-XNa.png" alt="شعار مؤسسة عبدالمنعم الراشد الإنسانية" class="logo">
      </div>
      <h1>مرحبًا بك في لوحة التحكم</h1>
      <p>نظام إدارة الموارد البشرية والمشاركين - مؤسسة عبدالمنعم الراشد الإنسانية</p>
    </header>

    <div class="buttons">
      <button class="primary" onclick="showSection('manage')" title="عرض وإدارة البيانات">
        <span>📊</span> إدارة البيانات
      </button>
      <button class="secondary" onclick="showSection('add')" title="إضافة شخص جديد">
        <span>➕</span> إضافة شخص جديد
      </button>
    </div>

    <div id="manage" class="section">
      <h2>إدارة البيانات</h2>
      <label for="departmentSelect">اختر القسم:</label>
      <select id="departmentSelect" onchange="loadEmployees()">
        <option value="">-- اختر القسم --</option>
        <option value="الموظفين">الموظفين</option>
        <option value="المتطوعين">المتطوعين</option>
        <option value="الشركاء">الشركاء</option>
        <option value="الإعلاميين">الإعلاميين</option>
        <option value="المستفيدين">المستفيدين</option>
        <option value="المتدربين">المتدربين</option>
        <option value="مجلس الأمناء">مجلس الأمناء</option>
        <option value="دار نوره الموسى للثقافة والفنون">دار نوره الموسى للثقافة والفنون</option>
        <option value="FAB LAB">FAB LAB</option>
        <option value="بيت الحرفيين">بيت الحرفيين</option>
        <option value="مركز الإبداع والابتكار للتدريب">مركز الإبداع والابتكار للتدريب</option>
      </select>

      <div id="statsContainer" class="stats-container" style="display: none;"></div>

      <div id="searchContainer" style="display:none; margin-top: 25px;">
        <label for="searchInput">🔍 ابحث في البيانات:</label>
        <input type="text" id="searchInput" oninput="filterTable()" placeholder="أدخل كلمة للبحث (اسم، جوال، إلخ)">
      </div>

      <div class="duplicate-names-container">
        <button class="primary" onclick="loadEmployees()" title="تحديث البيانات">تحديث البيانات</button>
        <button class="export" onclick="exportToExcel()" title="تصدير إلى Excel">تصدير كـ Excel</button>
        <div id="duplicateNames" class="duplicate-names">
          <h3>الأسماء المتكررة</h3>
          <ul id="duplicateList"></ul>
        </div>
      </div>

      <div id="loading">
        جاري التحميل... <span class="spinner"></span>
      </div>

      <div class="table-container">
        <table id="employeeTable">
          <thead id="tableHead"></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="add" class="section">
      <h2>إضافة شخص جديد</h2>
      <form id="addForm" action="/add_employee" method="POST" onsubmit="handleSubmit(event)">
        <label for="department">القسم *</label>
        <select name="department" id="department" onchange="updateFields()" required>
          <option value="">-- اختر القسم --</option>
          <option value="الموظفين">الموظفين</option>
          <option value="المتطوعين">المتطوعين</option>
          <option value="الشركاء">الشركاء</option>
          <option value="الإعلاميين">الإعلاميين</option>
          <option value="المستفيدين">المستفيدين</option>
          <option value="المتدربين">المتدربين</option>
          <option value="مجلس الأمناء">مجلس الأمناء</option>
          <option value="دار نوره الموسى للثقافة والفنون">دار نوره الموسى للثقافة والفنون</option>
          <option value="FAB LAB">FAB LAB</option>
          <option value="بيت الحرفيين">بيت الحرفيين</option>
          <option value="مركز الإبداع والابتكار للتدريب">مركز الإبداع والابتكار للتدريب</option>
        </select>

        <div id="extraFields"></div>

        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <button class="primary" type="submit" title="إضافة الشخص">إضافة الشخص</button>
          <button type="button" class="secondary" onclick="showSection('manage')" title="إلغاء">إلغاء</button>
        </div>
      </form>
    </div>

    <div id="duplicateDetailsModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal()" title="إغلاق">×</span>
        <h3>تفاصيل الأسماء المتكررة</h3>
        <table class="modal-table" id="duplicateDetailsTable">
          <thead id="modalTableHead"></thead>
          <tbody id="modalTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let allData = [];

    const themeToggle = document.querySelector('#theme-toggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        const icon = this.querySelector('i');
        if (document.body.classList.contains('dark-mode')) {
          icon.classList.remove('fa-moon');
          icon.classList.add('fa-sun');
        } else {
          icon.classList.remove('fa-sun');
          icon.classList.add('fa-moon');
        }
      });
    }

    window.addEventListener('scroll', function() {
      const logo = document.querySelector('.logo');
      if (window.scrollY > 50) {
        logo.classList.add('scrolled');
      } else {
        logo.classList.remove('scrolled');
      }
    });

    function findDuplicateNames(data) {
      const nameCounts = {};
      data.forEach(emp => {
        const name = emp.name.trim();
        nameCounts[name] = (nameCounts[name] || 0) + 1;
      });

      const duplicates = Object.entries(nameCounts)
        .filter(([name, count]) => count > 1)
        .map(([name, count]) => ({ name, count }));

      const duplicateList = document.getElementById('duplicateList');
      const duplicateContainer = document.getElementById('duplicateNames');

      if (duplicates.length > 0) {
        duplicateList.innerHTML = duplicates
          .map(dup => `<li onclick="showDuplicateDetails('${dup.name.replace(/'/g, "\\'")}')">${dup.name}: ${dup.count} مرات</li>`)
          .join('');
        duplicateContainer.style.display = 'block';
      } else {
        duplicateList.innerHTML = '<li>لا توجد أسماء متكررة</li>';
        duplicateContainer.style.display = 'block';
      }
    }

    function showDuplicateDetails(name) {
      const dept = document.getElementById('departmentSelect').value;
      const modal = document.getElementById('duplicateDetailsModal');
      const modalHead = document.getElementById('modalTableHead');
      const modalBody = document.getElementById('modalTableBody');
      modalBody.innerHTML = '';

      const matchingRecords = allData.filter(emp => emp.name.trim() === name);

      if (dept === "الموظفين") {
        modalHead.innerHTML = `<tr><th>الاسم</th><th>الجوال</th><th>الهوية/الإقامة</th><th>الرقم الوظيفي</th><th>البريد الإلكتروني</th><th>طبيعة الدوام</th><th>تاريخ التوظيف</th><th>المسمى الوظيفي</th><th>الملاحظات</th><th>العمليات</th></tr>`;
        matchingRecords.forEach(emp => {
          modalBody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.phone || '-'}</td><td>${emp.identity}</td><td>${emp.employee_id}</td><td>${emp.email || '-'}</td><td>${emp.work_type}</td><td>${emp.hire_date}</td><td>${emp.job_title}</td><td>${emp.notes || '-'}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><button class="delete" onclick="deleteFromModal(event, ${emp.id}, '${dept}')">حذف</button></div></td></tr>`;
        });
      } else if (dept === "المستفيدين") {
        modalHead.innerHTML = `<tr><th>الاسم الكامل</th><th>رقم الجوال</th><th>اسم المبادرة</th><th>العمليات</th></tr>`;
        matchingRecords.forEach(emp => {
          modalBody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.phone}</td><td>${emp.initiative}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><button class="delete" onclick="deleteFromModal(event, ${emp.id}, '${dept}')">حذف</button></div></td></tr>`;
        });
      } else if (dept === "مجلس الأمناء") {
        modalHead.innerHTML = `<tr><th>الاسم الكامل</th><th>السجل المدني</th><th>الجوال</th><th>الإيميل</th><th>العمليات</th></tr>`;
        matchingRecords.forEach(emp => {
          modalBody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.national_id}</td><td>${emp.phone}</td><td>${emp.email}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><button class="delete" onclick="deleteFromModal(event, ${emp.id}, '${dept}')">حذف</button></div></td></tr>`;
        });
      } else if (dept === "المتطوعين") {
        modalHead.innerHTML = `<tr><th>الاسم الكامل</th><th>رقم الجوال</th><th>السجل المدني</th><th>العمر</th><th>العمليات</th></tr>`;
        matchingRecords.forEach(emp => {
          modalBody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.phone}</td><td>${emp.national_id}</td><td>${emp.age}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><button class="delete" onclick="deleteFromModal(event, ${emp.id}, '${dept}')">حذف</button></div></td></tr>`;
        });
      } else {
        modalHead.innerHTML = `<tr><th>الاسم</th><th>العمر</th><th>الجوال</th><th>الإيميل</th><th>القسم</th><th>العمليات</th></tr>`;
        matchingRecords.forEach(emp => {
          modalBody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.age || '-'}</td><td>${emp.phone || '-'}</td><td>${emp.email || '-'}</td><td>${emp.department}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><button class="delete" onclick="deleteFromModal(event, ${emp.id}, '${dept}')">حذف</button></div></td></tr>`;
        });
      }

      modal.style.display = 'flex';
    }

    function closeModal() {
      const modal = document.getElementById('duplicateDetailsModal');
      modal.style.display = 'none';
    }

    function deleteFromModal(event, id, dept) {
      event.preventDefault();
      Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'لن تتمكن من استعادة هذه البيانات بعد الحذف!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء',
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/delete/${dept}/${id}`, { method: 'POST' })
            .then(res => {
              if (res.ok) {
                Swal.fire('تم الحذف!', 'تم حذف البيانات بنجاح.', 'success');
                closeModal();
                loadEmployees();
              } else {
                Swal.fire('خطأ!', 'حدث خطأ أثناء الحذف.', 'error');
              }
            });
        }
      });
    }

    function showSection(sectionId) {
      document.getElementById('manage').style.display = 'none';
      document.getElementById('add').style.display = 'none';
      document.getElementById(sectionId).style.display = 'block';
      if (sectionId === 'add') {
        document.getElementById('duplicateNames').style.display = 'none';
        document.getElementById('duplicateDetailsModal').style.display = 'none';
      }
    }

    function loadEmployees() {
      const dept = document.getElementById('departmentSelect').value;
      const searchContainer = document.getElementById('searchContainer');
      const statsContainer = document.getElementById('statsContainer');
      const loading = document.getElementById('loading');
      const duplicateContainer = document.getElementById('duplicateNames');
      searchContainer.style.display = dept ? 'block' : 'none';
      statsContainer.style.display = dept ? 'block' : 'none';
      loading.style.display = dept ? 'block' : 'none';
      duplicateContainer.style.display = 'none';

      fetch(`/get_employees/${dept}`)
        .then(res => res.json())
        .then(data => {
          allData = data;
          const thead = document.getElementById('tableHead');
          const tbody = document.querySelector('#employeeTable tbody');
          tbody.innerHTML = '';

          if (dept === "الموظفين") {
            thead.innerHTML = `<tr><th>الاسم</th><th>الجوال</th><th>الهوية/الإقامة</th><th>الرقم الوظيفي</th><th>البريد الإلكتروني</th><th>طبيعة الدوام</th><th>تاريخ التوظيف</th><th>المسمى الوظيفي</th><th>الملاحظات</th><th>العمليات</th></tr>`;
            data.forEach(emp => {
              tbody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.phone || '-'}</td><td>${emp.identity}</td><td>${emp.employee_id}</td><td>${emp.email || '-'}</td><td>${emp.work_type}</td><td>${emp.hire_date}</td><td>${emp.job_title}</td><td>${emp.notes || '-'}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><form action="/delete/${dept}/${emp.id}" method="POST"><button class="delete" onclick="confirmDelete(event, ${emp.id}, '${dept}')">حذف</button></form></div></td></tr>`;
            });
            updateStats(dept, data);
          } else if (dept === "المستفيدين") {
            thead.innerHTML = `<tr><th>الاسم الكامل</th><th>رقم الجوال</th><th>اسم المبادرة</th><th>العمليات</th></tr>`;
            data.forEach(emp => {
              tbody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.phone}</td><td>${emp.initiative}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><form action="/delete/${dept}/${emp.id}" method="POST"><button class="delete" onclick="confirmDelete(event, ${emp.id}, '${dept}')">حذف</button></form></div></td></tr>`;
            });
            updateStats(dept, data);
          } else if (dept === "مجلس الأمناء") {
            thead.innerHTML = `<tr><th>الاسم الكامل</th><th>السجل المدني</th><th>الجوال</th><th>الإيميل</th><th>العمليات</th></tr>`;
            data.forEach(emp => {
              tbody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.national_id}</td><td>${emp.phone}</td><td>${emp.email}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><form action="/delete/${dept}/${emp.id}" method="POST"><button class="delete" onclick="confirmDelete(event, ${emp.id}, '${dept}')">حذف</button></form></div></td></tr>`;
            });
            updateStats(dept, data);
          } else if (dept === "المتطوعين") {
            thead.innerHTML = `<tr><th>الاسم الكامل</th><th>رقم الجوال</th><th>السجل المدني</th><th>العمر</th><th>العمليات</th></tr>`;
            data.forEach(emp => {
              tbody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.phone}</td><td>${emp.national_id}</td><td>${emp.age}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><form action="/delete/${dept}/${emp.id}" method="POST"><button class="delete" onclick="confirmDelete(event, ${emp.id}, '${dept}')">حذف</button></form></div></td></tr>`;
            });
            updateStats(dept, data);
          } else {
            thead.innerHTML = `<tr><th>الاسم</th><th>العمر</th><th>الجوال</th><th>الإيميل</th><th>القسم</th><th>العمليات</th></tr>`;
            data.forEach(emp => {
              tbody.innerHTML += `<tr><td>${emp.name}</td><td>${emp.age || '-'}</td><td>${emp.phone || '-'}</td><td>${emp.email || '-'}</td><td>${emp.department}</td><td class="actions"><div><form action="/edit/${dept}/${emp.id}" method="GET"><button class="edit">تعديل</button></form></div><div><form action="/delete/${dept}/${emp.id}" method="POST"><button class="delete" onclick="confirmDelete(event, ${emp.id}, '${dept}')">حذف</button></form></div></td></tr>`;
            });
            updateStats(dept, data);
          }
          findDuplicateNames(data);
          loading.style.display = 'none';
        })
        .catch(err => {
          Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'حدث خطأ أثناء جلب البيانات، حاول مرة أخرى.',
          });
          loading.style.display = 'none';
        });
    }

    function confirmDelete(event, id, dept) {
      event.preventDefault();
      Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'لن تتمكن من استعادة هذه البيانات بعد الحذف!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء',
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/delete/${dept}/${id}`, { method: 'POST' })
            .then(res => {
              if (res.ok) {
                Swal.fire('تم الحذف!', 'تم حذف البيانات بنجاح.', 'success');
                loadEmployees();
              } else {
                Swal.fire('خطأ!', 'حدث خطأ أثناء الحذف.', 'error');
              }
            });
        }
      });
    }
    function updateStats(dept, data) {
  const statsContainer = document.getElementById('statsContainer');
  let statsHTML = `
    <h3>عدد السجلات</h3>
    <p>${data.length}</p>`;
  
  statsContainer.innerHTML = statsHTML;
}

    function filterTable() {
      const input = document.getElementById('searchInput').value.trim().toLowerCase();
      const searchTerms = input.split(/\s+/).filter(term => term.length > 0);
      const rows = document.querySelectorAll('#employeeTable tbody tr');

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let match = false;

        const nameCell = cells[0];
        if (nameCell && !nameCell.classList.contains('actions')) {
          const nameText = nameCell.textContent.toLowerCase();
          const allTermsInName = searchTerms.every(term => nameText.includes(term));
          if (allTermsInName) {
            match = true;
          }
        }

        cells.forEach(cell => {
          if (!cell.classList.contains('actions') && cell !== nameCell) {
            if (cell.textContent.toLowerCase().includes(input)) {
              match = true;
            }
          }
        });

        row.style.display = match ? '' : 'none';
      });
    }

    function updateFields() {
      const dept = document.getElementById('department').value;
      const container = document.getElementById('extraFields');
      container.innerHTML = '';

      if (dept === "الموظفين") {
        container.innerHTML = `
          <label for="name">الاسم</label>
          <input type="text" name="name">
          <label for="phone">الجوال</label>
          <input type="text" name="phone">
          <label for="identity">الهوية/الإقامة</label>
          <input type="text" name="identity" pattern="\\d{10}" title="الهوية/الإقامة يجب أن تتكون من 10 أرقام">
          <label for="employee_id">الرقم الوظيفي</label>
          <input type="text" name="employee_id">
          <label for="email">البريد الإلكتروني</label>
          <input type="email" name="email">
          <label for="work_type">طبيعة الدوام</label>
          <select name="work_type">
            <option value="">-- اختر --</option>
            <option value="دوام كامل">دوام كامل</option>
            <option value="دوام جزئي">دوام جزئي</option>
          </select>
          <label for="hire_date">تاريخ التوظيف</label>
          <input type="date" name="hire_date">
          <label for="job_title">المسمى الوظيفي</label>
          <input type="text" name="job_title">
          <label for="notes">الملاحظات</label>
          <textarea name="notes"></textarea>`;
      } else if (dept === "المستفيدين") {
        container.innerHTML = `
          <label for="name">الاسم الكامل</label>
          <input type="text" name="name">
          <label for="phone">رقم الجوال</label>
          <input type="text" name="phone">
          <label for="initiative">اسم المبادرة</label>
          <input type="text" name="initiative">`;
      } else if (dept === "مجلس الأمناء") {
        container.innerHTML = `
          <label for="name">الاسم الكامل</label>
          <input type="text" name="name">
          <label for="national_id">السجل المدني</label>
          <input type="text" name="national_id" pattern="\\d{10}" title="السجل المدني يجب أن يتكون من 10 أرقام">
          <label for="phone">رقم الجوال</label>
          <input type="text" name="phone">
          <label for="email">الإيميل</label>
          <input type="email" name="email">`;
      } else if (dept === "المتطوعين") {
        container.innerHTML = `
          <label for="name">الاسم الكامل</label>
          <input type="text" name="name">
          <label for="phone">رقم الجوال</label>
          <input type="text" name="phone">
          <label for="national_id">السجل المدني</label>
          <input type="text" name="national_id" pattern="\\d{10}" title="السجل المدني يجب أن يتكون من 10 أرقام">
          <label for="age">العمر</label>
          <input type="number" name="age" min="18" max="100">`;
      } else {
        container.innerHTML = `
          <label for="name">الاسم</label>
          <input type="text" name="name">
          <label for="age">العمر</label>
          <input type="number" name="age" min="18" max="100">
          <label for="phone">رقم الجوال</label>
          <input type="text" name="phone">
          <label for="email">الإيميل</label>
          <input type="email" name="email">`;
      }
    }

    function handleSubmit(e) {
      e.preventDefault();
      const form = document.getElementById('addForm');
      const formData = new FormData(form);
      const loading = document.getElementById('loading');
      loading.style.display = 'block';

      fetch(form.action, {
        method: 'POST',
        body: formData
      }).then(res => {
        loading.style.display = 'none';
        if (res.ok) {
          Swal.fire({
            icon: 'success',
            title: 'تمت الإضافة!',
            text: 'تم إضافة الشخص بنجاح.',
            timer: 2000,
            showConfirmButton: false
          });
          form.reset();
          updateFields();
          showSection('manage');
          loadEmployees();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'خطأ',
            text: 'حدث خطأ أثناء الإضافة، حاول مرة أخرى.'
          });
        }
      }).catch(err => {
        loading.style.display = 'none';
        Swal.fire({
          icon: 'error',
          title: 'خطأ',
          text: 'فشل الاتصال بالسيرفر، تحقق من الشبكة.'
        });
      });
    }

    function exportToExcel() {
      try {
        const table = document.getElementById('employeeTable');
        const rows = table.querySelectorAll('tr');
        if (rows.length <= 1) {
          Swal.fire({
            icon: 'warning',
            title: 'لا توجد بيانات',
            text: 'الجدول فارغ، اختر قسمًا وحمل البيانات أولاً.',
          });
          return;
        }

        const data = [];
        let headers = [];
        
        const headerRow = rows[0];
        headerRow.querySelectorAll('th').forEach((th, index) => {
          if (!th.classList.contains('actions')) {
            headers[index] = th.textContent.trim();
          }
        });

        for (let i = 1; i < rows.length; i++) {
          const cols = rows[i].querySelectorAll('td');
          const rowData = {};
          cols.forEach((col, index) => {
            if (!col.classList.contains('actions') && headers[index]) {
              rowData[headers[index]] = col.textContent.trim();
            }
          });
          if (Object.keys(rowData).length > 0) {
            data.push(rowData);
          }
        }

        if (data.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'لا توجد بيانات',
            text: 'لا توجد بيانات للتصدير، تأكد من تحميل البيانات.',
          });
          return;
        }

        const worksheet = XLSX.utils.json_to_sheet(data);
        worksheet['!cols'] = headers.map(() => ({ wch: 20 }));
        worksheet['!rtl'] = true;

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Employees');

        const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        saveAs(blob, 'employees.xlsx');
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'خطأ في التصدير',
          text: 'حدث خطأ أثناء تصدير الملف، حاول مرة أخرى.',
        });
      }
    }

    window.onclick = function(event) {
      const modal = document.getElementById('duplicateDetailsModal');
      if (event.target === modal) {
        closeModal();
      }
    };
  </script>
</body>
</html>